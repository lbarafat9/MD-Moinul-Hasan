<!-- START OF FILE: Smart Nokol Nobish Pro v3.5 (Upgraded) -->
<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡¶∏‡ßç‡¶Æ‡¶æ‡¶∞‡ßç‡¶ü ‡¶®‡¶ï‡¶≤ ‡¶®‡¶¨‡ßÄ‡¶∂ ‡¶™‡ßç‡¶∞‡ßã ‡ß©.‡ß´</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #00695c;
            --bg: #f0f2f5;
            --white: #ffffff;
            --text: #333;
            --danger: #d32f2f;
            --success: #2e7d32;
            --warning: #f9a825;
            --info: #1976d2;
            --office: #6a1b9a;
        }
        * { box-sizing: border-box; outline: none; }
        body {
            font-family: 'SolaimanLipi', sans-serif;
            margin: 0; background-color: var(--bg); color: var(--text);
            -webkit-tap-highlight-color: transparent;
        }

        /* --- ‡¶≤‡¶ó‡¶á‡¶® ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® --- */
        #loginScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--primary); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
            transition: background-color 0.3s;
        }
        .login-box {
            background: white; padding: 25px; border-radius: 15px; text-align: center; width: 85%; max-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .login-box input {
            width: 100%; padding: 12px; margin: 15px 0; font-size: 22px; text-align: center;
            border: 2px solid #ddd; border-radius: 8px; letter-spacing: 5px; color: #333;
        }
        .login-btn {
            background: #ff6f00; color: white; border: none; padding: 12px; width: 100%;
            border-radius: 8px; font-size: 18px; cursor: pointer; font-weight: bold;
        }

        /* --- ‡¶Æ‡ßá‡¶á‡¶® ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ --- */
        #mainApp { display: none; }

        /* ‡¶π‡ßá‡¶°‡¶æ‡¶∞ */
        .header {
            background-color: var(--primary); color: var(--white); padding: 15px 10px;
            display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: background-color 0.3s;
        }
        .menu-btn { font-size: 22px; cursor: pointer; padding: 5px; width: 40px; }
        
        .header-center {
            text-align: center; flex-grow: 1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .office-name { font-size: 16px; font-weight: bold; line-height: 1.2; margin-bottom: 2px; }
        .location { font-size: 11px; opacity: 0.9; margin-bottom: 5px; }
        
        .connection-dot {
            width: 10px; height: 10px; background-color: #ccc; border-radius: 50%;
            display: inline-block; margin-left: 5px; border: 2px solid white;
        }
        .connection-dot.online { background-color: #00e676; }
        .connection-dot.offline { background-color: #ff1744; }

        /* ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ */
        .sidebar {
            height: 100%; width: 260px; position: fixed; top: 0; left: -260px;
            background-color: var(--white); box-shadow: 2px 0 10px rgba(0,0,0,0.2);
            transition: 0.3s; z-index: 2000; overflow-y: auto;
        }
        .sidebar.active { left: 0; }
        .sidebar-header { background: var(--primary); color: white; padding: 20px; text-align: center; transition: background-color 0.3s; }
        .sidebar a {
            padding: 15px 20px; text-decoration: none; font-size: 15px; color: var(--text);
            display: flex; align-items: center; border-bottom: 1px solid #f0f0f0; cursor: pointer;
        }
        .sidebar a i { margin-right: 15px; width: 20px; text-align: center; color: var(--primary); }
        
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; z-index: 1500;
        }
        .overlay.active { display: block; }

        /* ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶á‡¶®‡¶æ‡¶∞ */
        .container { padding: 12px; padding-bottom: 90px; }

        /* ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° ‡¶ï‡¶æ‡¶∞‡ßç‡¶°‡¶∏ */
        .stats-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;
        }
        .stat-card {
            background: var(--white); padding: 15px; border-radius: 10px;
            text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; position: relative;
        }
        .stat-number { font-size: 20px; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 11px; color: #666; margin-top: 5px; }
        .office-card { border-bottom: 4px solid var(--office); }
        
        /* ‡¶ï‡ßç‡¶≤‡¶æ‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶ï‡¶æ‡¶∞‡ßç‡¶° */
        .client-card {
            background: var(--white); border-radius: 10px; padding: 12px; margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); border-left: 5px solid #ddd; position: relative;
        }
        .client-card.status-Pending { border-left-color: #757575; }
        .client-card.status-Processing { border-left-color: var(--warning); }
        .client-card.status-Ready { border-left-color: var(--success); }
        .client-card.status-Delivered { border-left-color: var(--primary); opacity: 0.6; }
        
        .client-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .client-name { font-weight: bold; font-size: 16px; }
        .dalil-no { background: #e0f2f1; padding: 2px 6px; border-radius: 4px; font-size: 12px; color: var(--primary); font-weight: bold; }

        .payment-info { 
            display: flex; justify-content: space-between; margin-top: 8px; font-size: 13px; 
            background: #f1f8e9; padding: 8px; border-radius: 6px; font-weight: bold;
        }
        
        .office-due-badge {
            font-size: 10px; color: var(--office); background: #f3e5f5; 
            padding: 2px 6px; border-radius: 4px; margin-top: 5px; display: inline-block; font-weight: bold;
        }

        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-small {
            flex: 1; padding: 8px; border: none; border-radius: 5px; font-size: 12px; cursor: pointer; color: white; text-align: center;
        }
        .btn-details { background: #5c6bc0; }
        .btn-pay { background: var(--success); }
        .btn-call { background: var(--primary); }

        /* ‡¶´‡ßç‡¶≤‡ßã‡¶ü‡¶ø‡¶Ç ‡¶¨‡¶æ‡¶ü‡¶® */
        .fab {
            position: fixed; bottom: 20px; right: 20px;
            background-color: var(--primary); color: white;
            width: 50px; height: 50px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; z-index: 900;
        }

        /* ‡¶Æ‡¶°‡¶æ‡¶≤ */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 3000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; padding: 20px; width: 95%; max-width: 380px;
            border-radius: 10px; max-height: 90vh; overflow-y: auto;
        }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; margin-bottom: 4px; font-size: 13px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        
        .bill-section-title { font-size: 12px; color: var(--primary); font-weight: bold; margin-top: 10px; border-bottom: 1px solid #eee; }
        .bill-input-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; 
            background: #f9f9f9; padding: 10px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 5px;
        }
        .bill-input-grid div { width: 100%; }
        .bill-input-grid input { width: 100%; box-sizing: border-box; }

        .total-display { text-align: center; font-weight: bold; color: var(--primary); margin: 10px 0; font-size: 16px; border-top: 1px solid #ddd; padding-top: 5px; }
        .btn-save { background: var(--primary); color: white; border: none; padding: 12px; width: 100%; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 5px; }

        .details-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .details-table td { padding: 8px; border-bottom: 1px solid #eee; font-size: 13px; }

        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .status-select { padding: 5px; border-radius: 4px; border: 1px solid #ddd; width: 100%; margin-top: 5px; }
        
        .settings-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .settings-title { font-weight: bold; margin-bottom: 10px; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; }

        /* --- ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ü‡ßá‡¶¨‡¶ø‡¶≤ --- */
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .report-table th { background: #eee; }

        /* --- ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶∏‡ßç‡¶ü‡¶æ‡¶á‡¶≤ (Thermal Printer) --- */
        @media print {
            @page { size: 58mm auto; margin: 0; }
            body { background: white; color: black; font-family: 'SolaimanLipi', sans-serif; }
            #sidebar, .header, .fab, .no-print, #loginScreen, .overlay { display: none !important; }
            .modal { position: static; background: white; display: block !important; }
            .modal-content { box-shadow: none; border: none; width: 100%; padding: 0; max-width: 100%; }
            .btn-save, .close-btn { display: none; }
            h3, h4, p { margin: 5px 0; text-align: center; }
            table { width: 100%; border-collapse: collapse; }
            td, th { border-bottom: 1px dashed #000; padding: 5px 0; text-align: left; font-size: 12px; }
            .total-row { font-weight: bold; border-top: 1px solid #000; }
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <i class="fas fa-shield-alt" style="font-size: 40px; color: var(--primary); margin-bottom: 10px;"></i>
            <h3>‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶§‡ßç‡¶§‡¶æ ‡¶™‡¶ø‡¶®</h3>
            <input type="password" id="pinInput" placeholder="****" maxlength="4" inputmode="numeric">
            <button class="login-btn" onclick="checkLogin()">‡¶≤‡¶ó‡¶á‡¶®</button>
            <p style="font-size: 10px; margin-top: 10px; opacity: 0.7;">Firebase Connected v3.5</p>
        </div>
    </div>

    <div id="mainApp">
        <!-- ‡¶∏‡¶æ‡¶á‡¶°‡¶¨‡¶æ‡¶∞ -->
        <div class="overlay" id="overlay" onclick="closeSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-user-circle" style="font-size: 40px; margin-bottom: 10px;"></i>
                <div style="font-weight: bold;" id="sidebarUserName">‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞‡¶ï‡¶æ‡¶∞‡ßÄ</div>
                <div style="font-size: 12px; opacity: 0.8;">‡¶®‡¶ï‡¶≤ ‡¶®‡¶¨‡ßÄ‡¶∂</div>
            </div>
            <a onclick="showSection('all')"><i class="fas fa-home"></i> ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</a>
            <a onclick="showSection('due')"><i class="fas fa-hand-holding-usd" style="color: var(--danger);"></i> ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ</a>
            <a onclick="showSection('pending')"><i class="fas fa-clock" style="color: var(--warning);"></i> ‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶ú</a>
            <a onclick="showSection('ready')"><i class="fas fa-check-circle" style="color: var(--success);"></i> ‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø</a>
            <a onclick="showSection('office')"><i class="fas fa-briefcase" style="color: var(--office);"></i> ‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨</a>
            <a onclick="showSection('expenses')"><i class="fas fa-calculator"></i> ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§‡¶æ</a>
            <a onclick="showSection('reports')"><i class="fas fa-chart-line"></i> ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü</a>
            <a onclick="showSection('settings')"><i class="fas fa-cog"></i> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</a>
            <a onclick="logout()"><i class="fas fa-sign-out-alt"></i> ‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</a>
        </div>

        <!-- ‡¶π‡ßá‡¶°‡¶æ‡¶∞ -->
        <div class="header">
            <div class="menu-btn" onclick="openSidebar()"><i class="fas fa-bars"></i></div>
            <div class="header-center">
                <div class="office-name" id="headerOfficeName">‡¶∏‡¶æ‡¶¨-‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßü</div>
                <div class="location">‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú <span id="connStatus" class="connection-dot offline"></span></div>
                <div class="user-badge">
                    <span class="user-name" id="headerUserName">‡¶®‡¶ï‡¶≤ ‡¶®‡¶¨‡ßÄ‡¶∂</span>
                    <span class="user-role"> ‡¶®‡¶ï‡¶≤ ‡¶®‡¶¨‡ßÄ‡¶∂ </span>
                </div>
            </div>
            <div style="width: 40px; text-align: right;" onclick="showSection('settings')"><i class="fas fa-sliders-h"></i></div>
        </div>

        <div class="container">
            <!-- ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶° -->
            <div id="dashboardView">
                <div class="stats-grid">
                    <div class="stat-card" onclick="showSection('all')">
                        <div class="stat-number" id="cashInHand" style="color: var(--primary);">0</div>
                        <div class="stat-label">‡¶®‡¶ó‡¶¶ ‡¶§‡¶π‡¶¨‡¶ø‡¶≤</div>
                    </div>
                    <div class="stat-card" onclick="showSection('due')">
                        <div class="stat-number" style="color: var(--danger);" id="totalCustomerDue">0</div>
                        <div class="stat-label">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ</div>
                    </div>
                    <div class="stat-card office-card" onclick="showSection('office')">
                        <div class="stat-number" style="color: var(--office);" id="totalOfficeDue">0</div>
                        <div class="stat-label">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡¶æ‡¶ì‡¶®‡¶æ</div>
                    </div>
                    <div class="stat-card" onclick="showSection('pending')">
                        <div class="stat-number" style="color: var(--warning);" id="totalPending">0</div>
                        <div class="stat-label">‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶ú</div>
                    </div>
                </div>
            </div>

            <!-- ‡¶≠‡¶ø‡¶â: ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ -->
            <div id="clientsView" class="view-section active">
                <h3 id="listTitle" style="margin: 0 0 15px 0; font-size: 16px; border-bottom: 2px solid #ddd; padding-bottom: 5px;">‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                <input type="text" id="searchInput" placeholder="üîç ‡¶®‡¶æ‡¶Æ ‡¶¨‡¶æ ‡¶¶‡¶≤‡¶ø‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 25px; margin-bottom: 15px;"
                       onkeyup="renderClients()">
                <div id="clientList"></div>
                <button id="loadMoreBtn" class="btn-save" style="background: #ddd; color: #333; margin-top: 10px; display:none;" onclick="loadMore()">‡¶Ü‡¶∞‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
            </div>

            <!-- ‡¶≠‡¶ø‡¶â: ‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ -->
            <div id="officeView" class="view-section">
                <h3>‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶π‡¶ø‡¶∏‡¶æ‡¶¨ (‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï)</h3>
                <div style="background: var(--white); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center;">
                    <div style="font-size: 12px; color: #666;">‡¶Æ‡ßã‡¶ü ‡¶á‡¶®‡ßç‡¶°‡ßã‡¶∏‡¶Æ‡ßá‡¶®‡ßç‡¶ü/‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ</div>
                    <div style="font-size: 24px; font-weight: bold; color: var(--office);" id="officeViewDue">0</div>
                    <p style="font-size: 10px; color: #888;">‡¶∏‡¶™‡ßç‡¶§‡¶æ‡¶π ‡¶∂‡ßá‡¶∑‡ßá ‡¶è‡¶á ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡ßÅ‡¶ù‡ßá ‡¶™‡ßá‡¶≤‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®</p>
                    <button class="btn-save" style="background: var(--office);" onclick="openOfficePayModal()">‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï ‡¶¨‡¶ø‡¶≤ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</button>
                </div>
                <div id="officeList"></div>
            </div>

            <!-- ‡¶≠‡¶ø‡¶â: ‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶ñ‡¶æ‡¶§‡¶æ -->
            <div id="expensesView" class="view-section">
                <h3>‡¶ñ‡¶∞‡¶ö‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ</h3>
                <div style="background: #fff; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div class="form-group"><input type="text" id="exDesc" placeholder="‡¶¨‡¶ø‡¶¨‡¶∞‡¶£"></div>
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <input type="number" id="exAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ">
                        <button onclick="addExpense()" style="background: var(--danger); color: white; border: none; padding: 10px; border-radius: 5px;">‡¶Ø‡ßã‡¶ó</button>
                    </div>
                </div>
                <div style="background: #e0f2f1; padding: 10px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; text-align: center;">
                    ‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö: <span id="totalExpenseDisplay" style="color: var(--danger);">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ
                </div>
                <div id="expenseList"></div>
            </div>

            <!-- ‡¶≠‡¶ø‡¶â: ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü -->
            <div id="reportsView" class="view-section">
                <h3>‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶è‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏</h3>
                <div class="settings-card">
                    <div class="form-group">
                        <label>‡¶∂‡ßÅ‡¶∞‡ßÅ‡¶∞ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="repStartDate">
                    </div>
                    <div class="form-group">
                        <label>‡¶∂‡ßá‡¶∑ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</label>
                        <input type="date" id="repEndDate">
                    </div>
                    <button class="btn-save" onclick="generateReport()">‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</button>
                </div>
                
                <div id="reportResult" style="display:none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="repIncome" style="color: var(--success);">0</div>
                            <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶Ü‡ßü</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="repExpense" style="color: var(--danger);">0</div>
                            <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶¨‡ßç‡¶Ø‡ßü</div>
                        </div>
                    </div>
                    <div style="background: white; padding: 10px; border-radius: 10px; text-align: center; margin-bottom: 15px;">
                        ‡¶®‡¶ø‡¶ü ‡¶≤‡¶æ‡¶≠: <span id="repProfit" style="font-weight: bold; font-size: 18px;">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ
                    </div>
                </div>
            </div>

            <!-- ‡¶≠‡¶ø‡¶â: ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ -->
            <div id="settingsView" class="view-section">
                <h3>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</h3>
                
                <div class="settings-card">
                    <div class="settings-title">‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤</div>
                    <div class="form-group">
                        <label>‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="setUserName" placeholder="‡¶®‡¶æ‡¶Æ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®">
                    </div>
                    <div class="form-group">
                        <label>‡¶Ö‡¶´‡¶ø‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ</label>
                        <input type="text" id="setOfficeName" placeholder="‡¶Ö‡¶´‡¶ø‡¶∏‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ">
                    </div>
                    <button class="btn-save" onclick="saveProfileSettings()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                </div>

                <div class="settings-card">
                    <div class="settings-title">‡¶°‡¶æ‡¶ü‡¶æ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™</div>
                    <button class="btn-save" style="background: #2e7d32; margin-bottom: 10px;" onclick="exportData()">üì• ‡¶è‡¶ï‡ßç‡¶∏‡ßá‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° (Excel)</button>
                    <button class="btn-save" style="background: var(--danger);" onclick="resetAllData()">‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü</button>
                </div>
            </div>
        </div>

        <div class="fab" id="addClientBtn" onclick="openModal()">
            <i class="fas fa-plus"></i>
        </div>

        <!-- ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Æ‡¶°‡¶æ‡¶≤ -->
        <div class="modal" id="entryModal">
            <div class="modal-content">
                <span onclick="closeModal('entryModal')" style="float: right; cursor: pointer; font-size: 24px;">&times;</span>
                <h3 style="margin-top: 0; color: var(--primary);">‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶ú</h3>
                <div class="form-group"><input type="text" id="cName" placeholder="‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ"></div>
                <div class="form-group">
                    <input type="tel" id="cMobile" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ (01xxxxxxxxx)" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '')">
                </div>
                <div class="form-group"><input type="text" id="cDalil" placeholder="‡¶¶‡¶≤‡¶ø‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞"></div>
                
                <div class="bill-section-title">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶¨‡ßá:</div>
                <div class="bill-input-grid">
                    <div><label style="font-size: 10px;">‡¶®‡¶ï‡¶≤ ‡¶´‡¶ø</label><input type="number" id="feeNokol" placeholder="0" oninput="calcTotal()"></div>
                    <div><label style="font-size: 10px;">‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞</label><input type="number" id="feeComputer" placeholder="0" oninput="calcTotal()"></div>
                    <div><label style="font-size: 10px;">‡¶§‡¶≤‡ßç‡¶≤‡¶æ‡¶∂/‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</label><input type="number" id="feeTollash" placeholder="0" oninput="calcTotal()"></div>
                </div>

                <div class="bill-section-title" style="color: var(--office);">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶¶‡¶ø‡¶¨‡ßá (‡¶∏‡¶æ‡¶™‡ßç‡¶§‡¶æ‡¶π‡¶ø‡¶ï):</div>
                <div class="bill-input-grid" style="background: #f3e5f5; border-color: #e1bee7;">
                    <div><label style="font-size: 10px;">‡¶á‡¶®‡ßç‡¶°‡ßã‡¶∏‡¶Æ‡ßá‡¶®‡ßç‡¶ü</label><input type="number" id="feeEndorse" placeholder="0" oninput="calcTotal()"></div>
                    <div><label style="font-size: 10px;">‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø (‡¶Ö‡¶´‡¶ø‡¶∏)</label><input type="number" id="feeOfficeOther" placeholder="0" oninput="calcTotal()"></div>
                </div>

                <div class="total-display">
                    ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ø‡¶≤: <span id="cTotalDisplay">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ<br>
                    <span style="font-size: 12px; color: var(--office);">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶™‡¶æ‡¶ì‡¶®‡¶æ: <span id="cOfficeDisplay">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ</span>
                </div>

                <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶ú‡¶Æ‡¶æ (‡¶Ö‡¶ó‡ßç‡¶∞‡¶ø‡¶Æ)</label><input type="number" id="cAdvance" oninput="calcTotal()" placeholder="0"></div>
                <div class="form-group"><label>‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßá‡ßü‡¶æ: <span id="cDueDisplay" style="color: red;">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ</label></div>
                <div class="form-group"><input type="date" id="cDate"></div>
                <button class="btn-save" onclick="saveClient()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- ‡¶°‡¶ø‡¶ü‡ßá‡¶á‡¶≤‡¶∏ ‡¶Æ‡¶°‡¶æ‡¶≤ -->
        <div class="modal" id="detailsModal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal('detailsModal')" style="float: right; cursor: pointer; font-size: 24px;">&times;</span>
                <h3 style="margin-top: 0; color: var(--primary); border-bottom: 1px solid #ddd; padding-bottom: 10px;">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</h3>
                <div id="detailsContent"></div>
                <div style="margin-top: 15px;" class="no-print">
                    <button class="btn-save" style="background: #455a64;" onclick="printCurrentMemo()"><i class="fas fa-print"></i> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶Æ‡ßá‡¶Æ‡ßã</button>
                </div>
            </div>
        </div>

        <!-- ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
        <div class="modal" id="paymentModal">
            <div class="modal-content">
                <span onclick="closeModal('paymentModal')" style="float: right; cursor: pointer; font-size: 24px;">&times;</span>
                <h3>‡¶ü‡¶æ‡¶ï‡¶æ ‡¶ú‡¶Æ‡¶æ (‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞)</h3>
                <p id="payName" style="font-weight: bold;"></p>
                <div class="form-group"><input type="number" id="newPaymentAmount" placeholder="‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£"></div>
                <input type="hidden" id="payClientId">
                <button class="btn-save" style="background: var(--success);" onclick="submitPayment()">‡¶ú‡¶Æ‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

        <!-- ‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡¶°‡¶æ‡¶≤ -->
        <div class="modal" id="officePayModal">
            <div class="modal-content">
                <span onclick="closeModal('officePayModal')" style="float: right; cursor: pointer; font-size: 24px;">&times;</span>
                <h3 style="color: var(--office);">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶¨‡¶ø‡¶≤ ‡¶ó‡ßç‡¶∞‡¶π‡¶£</h3>
                <p>‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶ì‡¶®‡¶æ: <span id="modalOfficeDue" style="font-weight: bold;">0</span> ‡¶ü‡¶æ‡¶ï‡¶æ</p>
                <div class="form-group">
                    <label>‡¶ï‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶¨‡ßÅ‡¶ù‡ßá ‡¶™‡ßá‡ßü‡ßá‡¶õ‡ßá‡¶®?</label>
                    <input type="number" id="officeReceivedAmount" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£">
                </div>
                <button class="btn-save" style="background: var(--office);" onclick="submitOfficePayment()">‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
            </div>
        </div>

    </div>

<script type="module">
    // --- Firebase Integration ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, remove, update, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCzq8ATdWjw4Ut65bEGVL08oS9SU-5I8Pk",
      authDomain: "md-moinul-hasan.firebaseapp.com",
      databaseURL: "https://md-moinul-hasan-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "md-moinul-hasan",
      storageBucket: "md-moinul-hasan.firebasestorage.app",
      messagingSenderId: "158273523711",
      appId: "1:158273523711:web:bf90523fbf578bfb9121ca"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Global Variables
    window.appSettings = { 
        pin: "1234", 
        themeColor: "#00695c", 
        userName: "‡¶Æ‡ßã‡¶É ‡¶Æ‡¶à‡¶®‡ßÅ‡¶≤ ‡¶π‡¶æ‡¶∏‡¶æ‡¶®", 
        officeName: "‡¶∏‡¶æ‡¶¨-‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡¶æ‡¶∞‡ßá‡¶∞ ‡¶ï‡¶æ‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßü" 
    };
    window.clients = [];
    window.expenses = [];
    window.officeTransactions = [];
    window.currentDetailId = null;
    window.renderLimit = 50; // Pagination Limit

    // --- Connection Monitor ---
    const connectedRef = ref(db, ".info/connected");
    onValue(connectedRef, (snap) => {
        const el = document.getElementById('connStatus');
        if (snap.val() === true) {
            el.classList.remove('offline'); el.classList.add('online');
        } else {
            el.classList.remove('online'); el.classList.add('offline');
        }
    });

    // --- Firebase Listeners ---
    onValue(ref(db, 'appSettings'), (snapshot) => {
        const data = snapshot.val();
        if (data) { window.appSettings = data; applySettings(); }
        else { set(ref(db, 'appSettings'), window.appSettings); }
    });

    onValue(ref(db, 'clients'), (snapshot) => {
        const data = snapshot.val();
        window.clients = data ? Object.values(data).sort((a,b) => b.id - a.id) : [];
        renderAll();
    });

    onValue(ref(db, 'expenses'), (snapshot) => {
        const data = snapshot.val();
        window.expenses = data ? Object.values(data).sort((a,b) => b.id - a.id) : [];
        renderAll();
    });

    onValue(ref(db, 'officeTransactions'), (snapshot) => {
        const data = snapshot.val();
        window.officeTransactions = data ? Object.values(data) : [];
        renderAll();
    });

    // --- Settings Apply ---
    window.applySettings = function() {
        document.documentElement.style.setProperty('--primary', window.appSettings.themeColor);
        if(document.getElementById('headerUserName')) document.getElementById('headerUserName').innerText = window.appSettings.userName;
        if(document.getElementById('sidebarUserName')) document.getElementById('sidebarUserName').innerText = window.appSettings.userName;
        if(document.getElementById('headerOfficeName')) document.getElementById('headerOfficeName').innerText = window.appSettings.officeName;
        if(document.getElementById('setUserName')) document.getElementById('setUserName').value = window.appSettings.userName;
        if(document.getElementById('setOfficeName')) document.getElementById('setOfficeName').value = window.appSettings.officeName;
    }
    
    // --- Init ---
    window.checkLogin = function() {
        if(document.getElementById('pinInput').value === window.appSettings.pin) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            renderAll();
        } else { alert("‡¶≠‡ßÅ‡¶≤ ‡¶™‡¶ø‡¶®!"); }
    }
    
    // --- Navigation ---
    window.openSidebar = function() { document.getElementById('sidebar').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
    window.closeSidebar = function() { document.getElementById('sidebar').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
    
    window.showSection = function(type) {
        closeSidebar();
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('addClientBtn').style.display = 'none';
        document.getElementById('dashboardView').style.display = 'none';

        if(type === 'all' || type === 'due' || type === 'pending' || type === 'ready') {
            document.getElementById('dashboardView').style.display = 'block';
            if(type !== 'all') { 
                 document.getElementById('clientsView').classList.add('active');
                 document.getElementById('addClientBtn').style.display = 'flex';
            }
        } else if(type === 'expenses') {
            document.getElementById('expensesView').classList.add('active');
        } else if(type === 'office') {
            document.getElementById('officeView').classList.add('active');
        } else if(type === 'reports') {
            document.getElementById('reportsView').classList.add('active');
        } else if(type === 'settings') {
            document.getElementById('settingsView').classList.add('active');
        }
        
        if(type === 'all') { 
            document.getElementById('clientsView').classList.add('active');
            document.getElementById('addClientBtn').style.display = 'flex';
        }

        const titles = { 'all': '‡¶∏‡¶¨ ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ', 'due': '‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ', 'pending': '‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶ï‡¶æ‡¶ú‡ßá‡¶∞ ‡¶§‡¶æ‡¶≤‡¶ø‡¶ï‡¶æ', 'ready': '‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶ï‡¶æ‡¶ú' };
        if(titles[type]) document.getElementById('listTitle').innerText = titles[type];

        window.renderLimit = 50; // Reset limit on section change
        renderClients(type);
    }

    // --- Settings Logic ---
    window.saveProfileSettings = function() {
        const newSettings = { ...window.appSettings };
        newSettings.userName = document.getElementById('setUserName').value;
        newSettings.officeName = document.getElementById('setOfficeName').value;
        set(ref(db, 'appSettings'), newSettings).then(() => alert("‡¶™‡ßç‡¶∞‡ßã‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡ßü‡ßá‡¶õ‡ßá!"));
    }

    // --- Logic: Calculation ---
    window.calcTotal = function() {
        const feeNokol = parseFloat(document.getElementById('feeNokol').value)||0;
        const feeComputer = parseFloat(document.getElementById('feeComputer').value)||0;
        const feeTollash = parseFloat(document.getElementById('feeTollash').value)||0;
        const custTotal = feeNokol + feeComputer + feeTollash;

        const feeEndorse = parseFloat(document.getElementById('feeEndorse').value)||0;
        const feeOfficeOther = parseFloat(document.getElementById('feeOfficeOther').value)||0;
        const officeTotal = feeEndorse + feeOfficeOther;

        document.getElementById('cTotalDisplay').innerText = custTotal;
        document.getElementById('cOfficeDisplay').innerText = officeTotal;

        const adv = parseFloat(document.getElementById('cAdvance').value)||0;
        document.getElementById('cDueDisplay').innerText = custTotal - adv;
    }

    window.saveClient = function() {
        const name = document.getElementById('cName').value;
        const mobile = document.getElementById('cMobile').value;
        
        if(!name) { alert("‡¶®‡¶æ‡¶Æ ‡¶¶‡¶ø‡¶®!"); return; }
        if(mobile.length !== 11 || !mobile.startsWith('01')) { alert("‡¶∏‡¶†‡¶ø‡¶ï ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶¶‡¶ø‡¶®!"); return; }

        const feeNokol = parseFloat(document.getElementById('feeNokol').value)||0;
        const feeComputer = parseFloat(document.getElementById('feeComputer').value)||0;
        const feeTollash = parseFloat(document.getElementById('feeTollash').value)||0;
        const feeEndorse = parseFloat(document.getElementById('feeEndorse').value)||0;
        const feeOfficeOther = parseFloat(document.getElementById('feeOfficeOther').value)||0;

        const custTotal = feeNokol + feeComputer + feeTollash;
        const officeTotal = feeEndorse + feeOfficeOther;
        const advance = parseFloat(document.getElementById('cAdvance').value)||0;
        
        const id = Date.now();
        const newClient = {
            id: id,
            name, mobile, dalil: document.getElementById('cDalil').value,
            feeNokol, feeComputer, feeTollash,
            feeEndorse, feeOfficeOther,
            custTotal, officeTotal, advance,
            due: custTotal - advance,
            isOfficePaid: false,
            date: document.getElementById('cDate').value,
            status: 'Pending'
        };

        set(ref(db, 'clients/' + id), newClient);
        closeModal('entryModal');
        clearForm();
    }

    // --- Rendering (Optimized) ---
    window.renderClients = function(filterType = 'all') {
        const listDiv = document.getElementById('clientList');
        const search = document.getElementById('searchInput').value.toLowerCase();
        listDiv.innerHTML = '';

        let filtered = window.clients.filter(c => {
            if(c.custTotal === undefined) { c.custTotal = c.total; c.officeTotal = 0; c.feeTollash = c.feeOther; }
            let match = true;
            if(filterType === 'due' && c.due <= 0) match = false;
            if(filterType === 'pending' && c.status === 'Delivered') match = false;
            if(filterType === 'ready' && c.status !== 'Ready') match = false;
            if(search && !c.name.toLowerCase().includes(search) && !c.dalil.includes(search)) match = false;
            return match;
        });

        // Pagination Logic
        const totalItems = filtered.length;
        const toShow = filtered.slice(0, window.renderLimit);

        toShow.forEach(c => {
            const html = `
            <div class="client-card status-${c.status}">
                <div class="client-header">
                    <div class="client-name">${c.name}</div>
                    <div class="dalil-no">${c.dalil || '‡¶¶‡¶≤‡¶ø‡¶≤ ‡¶®‡ßá‡¶á'}</div>
                </div>
                <div class="payment-info">
                    <span>‡¶¨‡¶ø‡¶≤: ${c.custTotal}</span>
                    <span>‡¶ú‡¶Æ‡¶æ: ${c.advance}</span>
                    <span style="color: ${c.due > 0 ? 'red' : 'green'};">‡¶¨‡¶æ‡¶ï‡¶ø: ${c.due}</span>
                </div>
                ${c.officeTotal > 0 && !c.isOfficePaid ? `<div class="office-due-badge">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶™‡¶æ‡¶ì‡¶®‡¶æ: ${c.officeTotal}</div>` : ''}
                <select class="status-select" onchange="updateStatus(${c.id}, this.value)">
                    <option value="Pending" ${c.status==='Pending'?'selected':''}>‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶Æ‡¶æ‡¶®</option>
                    <option value="Processing" ${c.status==='Processing'?'selected':''}>‡¶ö‡¶≤‡¶Æ‡¶æ‡¶®</option>
                    <option value="Ready" ${c.status==='Ready'?'selected':''}>‡¶∞‡ßá‡¶°‡¶ø</option>
                    <option value="Delivered" ${c.status==='Delivered'?'selected':''}>‡¶°‡ßá‡¶≤‡¶ø‡¶≠‡¶æ‡¶∞‡¶°</option>
                </select>
                <div class="btn-group">
                    <button class="btn-small btn-details" onclick="viewDetails(${c.id})">‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§</button>
                    ${c.due > 0 ? `<button class="btn-small btn-pay" onclick="openPayModal(${c.id})">‡¶ú‡¶Æ‡¶æ</button>` : ''}
                    <a href="tel:${c.mobile}" class="btn-small btn-call">‡¶ï‡¶≤</a>
                    <button class="btn-small" style="background:#d32f2f;" onclick="deleteClient(${c.id})">X</button>
                </div>
            </div>`;
            listDiv.innerHTML += html;
        });

        const loadBtn = document.getElementById('loadMoreBtn');
        if(totalItems > window.renderLimit) {
            loadBtn.style.display = 'block';
            loadBtn.innerText = `‡¶Ü‡¶∞‡¶ì ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (${totalItems - window.renderLimit} ‡¶ü‡¶ø ‡¶¨‡¶æ‡¶ï‡¶ø)`;
        } else {
            loadBtn.style.display = 'none';
        }
    }

    window.loadMore = function() {
        window.renderLimit += 50;
        renderClients(); // Re-render with new limit
    }

    window.viewDetails = function(id) {
        window.currentDetailId = id;
        const c = window.clients.find(x => x.id === id);
        const ft = c.feeTollash || c.feeOther || 0;
        const ot = c.officeTotal || 0; 
        const ct = c.custTotal || c.total;

        const html = `
            <table class="details-table">
                <tr><td colspan="2" style="background:#eee;">‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞ ‡¶Ö‡¶Ç‡¶∂</td></tr>
                <tr><td>‡¶®‡¶ï‡¶≤ ‡¶´‡¶ø</td><td>${c.feeNokol}</td></tr>
                <tr><td>‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞</td><td>${c.feeComputer}</td></tr>
                <tr><td>‡¶§‡¶≤‡ßç‡¶≤‡¶æ‡¶∂/‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</td><td>${ft}</td></tr>
                <tr><td style="font-weight:bold;">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ø‡¶≤ (‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞)</td><td style="font-weight:bold;">${ct}</td></tr>
                <tr><td>‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá</td><td>${c.advance}</td></tr>
                <tr><td style="color:red;">‡¶¨‡¶ï‡ßá‡ßü‡¶æ (‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ‡¶æ‡¶∞)</td><td style="color:red; font-weight:bold;">${c.due}</td></tr>
                <tr><td colspan="2" style="background:#f3e5f5; color:var(--office);">‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶Ö‡¶Ç‡¶∂</td></tr>
                <tr><td>‡¶á‡¶®‡ßç‡¶°‡ßã‡¶∏‡¶Æ‡ßá‡¶®‡ßç‡¶ü</td><td>${c.feeEndorse || 0}</td></tr>
                <tr><td>‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø</td><td>${c.feeOfficeOther || 0}</td></tr>
                <tr><td style="font-weight:bold;">‡¶Æ‡ßã‡¶ü ‡¶™‡¶æ‡¶ì‡¶®‡¶æ</td><td style="font-weight:bold;">${ot}</td></tr>
                <tr><td>‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</td><td>${c.isOfficePaid ? '‡¶™‡¶∞‡¶ø‡¶∂‡ßã‡¶ß‡¶ø‡¶§' : '‡¶Ö‡¶®‡¶æ‡¶¶‡¶æ‡ßü‡ßÄ'}</td></tr>
            </table>
        `;
        document.getElementById('detailsContent').innerHTML = html;
        document.getElementById('detailsModal').style.display = 'flex';
    }

    window.printCurrentMemo = function() {
        const c = window.clients.find(x => x.id === window.currentDetailId);
        const ct = c.custTotal || c.total;
        const ft = c.feeTollash || c.feeOther || 0;

        // Thermal Printer Friendly Layout
        const win = window.open('', '', 'width=400,height=600');
        win.document.write(`
            <html><head><title>Memo</title>
            <style>
                body{font-family:'SolaimanLipi',sans-serif; padding:10px; margin:0; font-size:12px;}
                h3,h4,p{text-align:center; margin:2px 0;}
                table{width:100%; border-collapse:collapse; margin-top:10px;}
                td{padding:4px 0; border-bottom:1px dashed #000;}
                .total{font-weight:bold; border-top:1px solid #000;}
            </style>
            </head><body>
            <h3>${window.appSettings.officeName}</h3>
            <p>‡¶ï‡¶æ‡¶∂‡¶ø‡ßü‡¶æ‡¶®‡ßÄ, ‡¶ó‡ßã‡¶™‡¶æ‡¶≤‡¶ó‡¶û‡ßç‡¶ú</p>
            <p>--------------------------------</p>
            <p>‡¶®‡¶æ‡¶Æ: ${c.name}</p>
            <p>‡¶¶‡¶≤‡¶ø‡¶≤: ${c.dalil}</p>
            <p>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${new Date().toLocaleDateString('bn-BD')}</p>
            <table>
                <tr><td>‡¶®‡¶ï‡¶≤ ‡¶´‡¶ø</td><td align="right">${c.feeNokol}</td></tr>
                <tr><td>‡¶ï‡¶Æ‡ßç‡¶™‡¶ø‡¶â‡¶ü‡¶æ‡¶∞</td><td align="right">${c.feeComputer}</td></tr>
                <tr><td>‡¶§‡¶≤‡ßç‡¶≤‡¶æ‡¶∂/‡¶¨‡¶ø‡¶¨‡¶ø‡¶ß</td><td align="right">${ft}</td></tr>
                <tr class="total"><td>‡¶∏‡¶∞‡ßç‡¶¨‡¶Æ‡ßã‡¶ü</td><td align="right">${ct}</td></tr>
                <tr><td>‡¶ú‡¶Æ‡¶æ</td><td align="right">${c.advance}</td></tr>
                <tr class="total"><td>‡¶¨‡¶ï‡ßá‡ßü‡¶æ</td><td align="right">${c.due}</td></tr>
            </table>
            <p style="margin-top:20px; text-align:center;">‡¶ß‡¶®‡ßç‡¶Ø‡¶¨‡¶æ‡¶¶</p>
            </body></html>
        `);
        win.document.close();
        win.focus();
        setTimeout(() => { win.print(); win.close(); }, 500);
    }

    // --- Financial Logic ---
    window.openPayModal = function(id) {
        const c = window.clients.find(x => x.id === id);
        document.getElementById('payClientId').value = id;
        document.getElementById('payName').innerText = c.name + " (‡¶¨‡¶æ‡¶ï‡¶ø: " + c.due + ")";
        document.getElementById('paymentModal').style.display = 'flex';
    }

    window.submitPayment = function() {
        const id = parseInt(document.getElementById('payClientId').value);
        const amt = parseFloat(document.getElementById('newPaymentAmount').value);
        const c = window.clients.find(x => x.id === id);
        if(c && amt > 0) {
            const newAdvance = c.advance + amt;
            const newDue = c.custTotal - newAdvance;
            update(ref(db, 'clients/' + id), { advance: newAdvance, due: newDue });
            closeModal('paymentModal');
        }
    }

    window.getOfficeDue = function() {
        return window.clients.reduce((sum, c) => {
            if(c.officeTotal > 0 && !c.isOfficePaid) return sum + c.officeTotal;
            return sum;
        }, 0);
    }

    window.openOfficePayModal = function() {
        const due = getOfficeDue();
        if(due <= 0) { alert("‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡¶ï‡ßá‡ßü‡¶æ ‡¶®‡ßá‡¶á!"); return; }
        document.getElementById('modalOfficeDue').innerText = due;
        document.getElementById('officeReceivedAmount').value = due;
        document.getElementById('officePayModal').style.display = 'flex';
    }

    window.submitOfficePayment = function() {
        const amount = parseFloat(document.getElementById('officeReceivedAmount').value);
        if(!amount || amount <= 0) return;
        const newTx = { date: new Date().toISOString(), amount: amount };
        push(ref(db, 'officeTransactions'), newTx);
        let remaining = amount;
        const updates = {};
        window.clients.forEach(c => {
            if(c.officeTotal > 0 && !c.isOfficePaid && remaining > 0) {
                updates['clients/' + c.id + '/isOfficePaid'] = true;
            }
        });
        update(ref(db), updates);
        closeModal('officePayModal');
        alert("‡¶Ö‡¶´‡¶ø‡¶∏ ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶´‡¶≤!");
    }

    window.updateStatus = function(id, st) { update(ref(db, 'clients/' + id), { status: st }); }
    window.deleteClient = function(id) { if(confirm("‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?")) { remove(ref(db, 'clients/' + id)); } }

    window.openModal = function() { document.getElementById('entryModal').style.display = 'flex'; document.getElementById('cDate').valueAsDate = new Date(); }
    window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
    window.clearForm = function() { 
        ['cName','cMobile','cDalil','feeNokol','feeComputer','feeTollash','feeEndorse','feeOfficeOther','cAdvance'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('cTotalDisplay').innerText = '0'; document.getElementById('cOfficeDisplay').innerText = '0';
    }
    window.logout = function() { location.reload(); }
    window.resetAllData = function() { if(confirm("‡¶∏‡¶§‡¶∞‡ßç‡¶ï‡¶§‡¶æ: ‡¶∏‡¶¨ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá!")) { remove(ref(db)); location.reload(); } }
    
    window.addExpense = function() {
        const desc = document.getElementById('exDesc').value;
        const amt = parseFloat(document.getElementById('exAmount').value);
        if(desc && amt) {
            const id = Date.now();
            set(ref(db, 'expenses/' + id), {id: id, desc, amount: amt, date: new Date().toISOString()});
            document.getElementById('exDesc').value = ''; document.getElementById('exAmount').value = '';
        }
    }

    // --- Report Logic ---
    window.generateReport = function() {
        const start = new Date(document.getElementById('repStartDate').value);
        const end = new Date(document.getElementById('repEndDate').value);
        
        if(isNaN(start) || isNaN(end)) { alert("‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®"); return; }
        end.setHours(23,59,59); // Include full end day

        let income = 0;
        let expense = 0;

        // Calculate Income (from Clients created in range)
        window.clients.forEach(c => {
            const cDate = new Date(c.date);
            if(cDate >= start && cDate <= end) {
                income += (c.advance || 0); // Only counted collected money
            }
        });

        // Calculate Expense
        window.expenses.forEach(e => {
            const eDate = new Date(e.date || e.id); // Fallback to ID timestamp
            if(eDate >= start && eDate <= end) {
                expense += (e.amount || 0);
            }
        });

        document.getElementById('repIncome').innerText = income;
        document.getElementById('repExpense').innerText = expense;
        document.getElementById('repProfit').innerText = income - expense;
        document.getElementById('reportResult').style.display = 'block';
    }

    // --- Export Logic ---
    window.exportData = function() {
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // BOM for Bengali support
        csvContent += "Name,Mobile,Dalil,Total Bill,Paid,Due,Status,Date\n";

        window.clients.forEach(c => {
            const row = [
                `"${c.name}"`, 
                `"${c.mobile}"`, 
                `"${c.dalil}"`, 
                c.custTotal, 
                c.advance, 
                c.due, 
                c.status, 
                c.date
            ].join(",");
            csvContent += row + "\n";
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "nokol_nobish_data.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    // --- Main Render Loop ---
    window.renderAll = function() {
        renderClients();
        
        let totalExpense = window.expenses.reduce((s, e) => s + e.amount, 0);
        let custCollected = window.clients.reduce((s, c) => s + c.advance, 0);
        let officeCollected = window.officeTransactions.reduce((s, t) => s + t.amount, 0);
        
        let cash = (custCollected + officeCollected) - totalExpense;
        let custDue = window.clients.reduce((s, c) => s + c.due, 0);
        let officeDue = getOfficeDue();
        let pending = window.clients.filter(c => c.status !== 'Delivered').length;

        document.getElementById('cashInHand').innerText = cash + ' ‡ß≥';
        document.getElementById('totalCustomerDue').innerText = custDue + ' ‡ß≥';
        document.getElementById('totalOfficeDue').innerText = officeDue + ' ‡ß≥';
        document.getElementById('officeViewDue').innerText = officeDue + ' ‡ß≥';
        document.getElementById('totalPending').innerText = pending;
        
        const exList = document.getElementById('expenseList'); exList.innerHTML = '';
        window.expenses.forEach(ex => exList.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;">${ex.desc} <span style="float:right; color:red;">-${ex.amount}</span></div>`);
        document.getElementById('totalExpenseDisplay').innerText = totalExpense;
    }
</script>
</body>
</html>